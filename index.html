<!-- index.html to test what markup would look like locally (independent of target) -->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Q Quiz</title>
    <meta name="description" content="">
    <link rel="stylesheet" href="https://service.sophie.nzz.ch/bundle/sophie-q@^1.2.0-rc.2,sophie-font@^1.2.0-rc.2,sophie-color@^1.1.0-rc,sophie-viz-color@^1.2.0-rc,sophie-input@^1.2.0-rc.4.css">
    <!-- In current (non niobe) design this set on q embeds -
      to test if colors are correct we add it here, might be removed later with niobe -->
    <style>
      .widget--qembed .card>div>[class*=" q-"], 
      .widget--qembed .card>div>[class^=q-], 
      .widget--qembed>div>[class*=" q-"], 
      .widget--qembed>div>[class^=q-] {
        color: #fff;
      }
    </style>
    <script src="https://rawgit.com/filamentgroup/loadCSS/master/src/loadCSS.js"></script> 
    <script>
      /*! loadJS: load a JS file asynchronously. [c]2014 @scottjehl, Filament Group, Inc. (Based on http://goo.gl/REQGQ by Paul Irish). Licensed MIT */
      (function( w ){
        var loadJS = function( src, cb ){
          "use strict";
          var ref = w.document.getElementsByTagName( "script" )[ 0 ];
          var script = w.document.createElement( "script" );
          script.src = src;
          script.async = true;
          ref.parentNode.insertBefore( script, ref );
          if (cb && typeof(cb) === "function") {
            script.onload = cb;
          }
          return script;
        };
        // commonjs
        if( typeof module !== "undefined" ){
          module.exports = loadJS;
        }
        else {
          w.loadJS = loadJS;
        }
      }( typeof global !== "undefined" ? global : this ));
    </script>
  </head>
  <body>
    <div id="container" class="widget widget--qembed entry">
      <div id="quiz"></div>
    </div>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.some other stuff </div>
    <script src="node_modules/systemjs/dist/system-production.js"></script> 
    <script>
      let data = {
        "item": {
          "title": "Ein tolles Quiz",
          "elements": [
            {
              "id": "86a6d3bc3be11a1cf51f7c12bd10858c-1503673199200-897399321",
              "type": "cover"
            },
            {
              "id": "86a6d3bc3be11a1cf51f7c12bd10858c-1503673205043-233776299",
              "type": "multipleChoice",
              "image": {},
              "choices": [
                "vielleicht",
                "falsch",
                "absolut falsch"
              ],
              "articleRecommendations": [],
              "question": "Was ist die richtige Antwort?",
              "answer": "richtig"
            },
            {
              "id": "86a6d3bc3be11a1cf51f7c12bd10858c-1503673244888-827300797",
              "type": "numberGuess",
              "image": {},
              "articleRecommendations": [],
              "question": "Hausnummer der NZZ",
              "answer": 11,
              "min": 1,
              "max": 150000,
              "step": 1
            },
            {
              "id": "86a6d3bc3be11a1cf51f7c12bd10858c-1503673375520-572013568",
              "type": "numberGuess",
              "image": {},
              "articleRecommendations": [],
              "question": "Temperatur",
              "answer": 25,
              "min": 1,
              "max": 35,
              "step": 1
            },
            {
              "id": "86a6d3bc3be11a1cf51f7c12bd10858c-1503673602641-999859280",
              "type": "mapPointGuess",
              "answer": {
                "type": "Feature",
                "geometry": {
                  "type": "Point",
                  "coordinates": [
                    8.548714,
                    47.3664
                  ]
                },
                "properties": {
                  "pointLabel": "NZZ Red",
                  "label": "11 Falkenstrasse"
                },
                "bbox": [
                  8.50547790527344,
                  47.347779215247144,
                  8.591995239257814,
                  47.38498483918202
                ]
              },
              "image": {},
              "articleRecommendations": [],
              "question": "wo ist die nzz?"
            },
            {
              "id": "86a6d3bc3be11a1cf51f7c12bd10858c-1503673653497-139543834",
              "type": "mapPointGuess",
              "answer": {
                "type": "Feature",
                "geometry": {
                  "type": "Point",
                  "coordinates": [
                    13.42632293701172,
                    51.456574106519724
                  ]
                },
                "properties": {
                  "pointLabel": "Kuhkaff",
                  "label": "Röderland"
                },
                "bbox": [
                  2.4169921875000004,
                  46.830133640447414,
                  24.565429687500004,
                  55.60317816902704
                ]
              },
              "image": {},
              "articleRecommendations": [],
              "question": "wo kommt sharon her?"
            },
            {
              "id": "86a6d3bc3be11a1cf51f7c12bd10858c-1503673750136-872919612",
              "type": "lastCard",
              "title": "Geschafft. Danke fürs Mitspielen.",
              "quizLink": "https://www.nzz.ch/feuilleton/nzz-quizz-twin-peaks-kehrt-zurueck-ld.1294313",
              "quizTitle": "Was wissen Sie über Twin Peaks",
              "isFinalScoreShown": true,
              "articleRecommendations": [],
              "text": "Ui so ein Spass"
            }
          ],
        },
        toolRuntimeConfig: {
          toolBaseUrl: `http://localhost:3000`,
          isPure: true
        }
      };

      function loadAllScripts(scripts, index, callback) {
        if (scripts[index] && scripts[index].url) {
          loadJS(scripts[index].url, () => {
            loadAllScripts(scripts, index + 1, callback)
          })
        } else {
          callback();
        }
      }

      // setup event listeners to show tracking events
      document.getElementById('quiz')
        .addEventListener('q-quiz-next-screen', event => {
          console.log(event);
        })
      document.getElementById('quiz')
        .addEventListener('q-quiz-answer', event => {
          console.log(event);
        })

      fetch(`http://localhost:3000/rendering-info/html-js`, {
          method: 'POST',
          body: JSON.stringify(data),
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          return response.json();
        })
        .then(data => {
          data.stylesheets.forEach(stylesheet => {
            if (stylesheet.name) {
              stylesheet.url = `http://localhost:3000/stylesheet/${stylesheet.name}`
            }
            loadCSS(stylesheet.url)
          })
          document.getElementById('quiz').innerHTML = data.markup;

          if (!data.scripts) {
            return;
          }
          data.scripts = data.scripts
            .map(script => {
              if (script.name) {
                script.url = `http://${window.location.hostname}:3000/script/${script.name}`
              }
              return script;
            })
          let urlScripts = data.scripts
            .filter(script => script.url)
          let contentScripts = data.scripts
            .filter(script => script.content)
          loadAllScripts(urlScripts, 0, () => {
            contentScripts.forEach(script => {
              let scriptElement = document.createElement('script');
              scriptElement.innerHTML = script.content;
              document.getElementById('quiz').appendChild(scriptElement);
            })
          })
        })
    </script>
  </body>
</html>
